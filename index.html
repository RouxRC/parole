<!DOCTYPE html>
<html>
<head>
 <meta charset="UTF-8">
 <title>Parole - Regards Citoyens</title>
 <link href="css/roboto.css" rel="stylesheet">
 <link href="css/vuetify.min.css" rel="stylesheet">
<style>
html {
  overflow: hidden;
}
.btn--floating.btn--small .icon {
  font-size: 30px;
}
.subheader {
  text-transform: uppercase;
}
.list [disabled] {
  background-color: #f44336;
  opacity: 1!important;
}
.input-group--select .input-group__selections__comma {
  font-size: 14px;
}
.list__tile--active, .input-group.input-group--focused .input-group__append-icon, .application--dark .input-group.input-group--dirty .input-group__selections__comma:not(.input-group__selections__comma--active) {
  color: #f44336;
}
.unselected .list__tile--active, .unselected .input-group.input-group--focused .input-group__append-icon, .application--dark .unselected .input-group.input-group--dirty .input-group__selections__comma:not(.input-group__selections__comma--active) {
  color: white!important;
  opacity: 0.2!important;
}
.input-group.input-group--text-field:not(.input-group--single-line):not(.input-group--error).input-group--focused label {
  color: white;
}
.input-group.input-group--selection-controls.switch {
  left: 35%;
}
.application .selected .theme--light.switch.input-group--disabled .input-group--selection-controls__ripple:after {
  background-color: #f44336!important;
}
.application .selected .theme--light.switch.input-group--disabled .input-group--selection-controls__toggle {
  color: #f44336!important;
}
.axis path, .axis line {
  stroke: grey;
}
.axis text {
  fill: grey;
  font-size: 14px;
  font-family: Roboto;
}
.legende {
  position: relative;
  bottom: 90px;
}
.legende button {
  color: black!important;
  font-weight: bold;
}
rect.tooltip {
  fill: black;
  fill-opacity: 0;
}
.tooltipBox {
  background: lightgrey;
  border: 1px solid black;
  border-radius: 5px;
  color: black;
  display: none;
  min-width: 200px;
  position: absolute;
  top: 50%;
  left: 50%;
  padding: 7px;
  font-size: 14px;
  z-index: 1000;
}
.tooltipBox table {
  margin: auto;
  width: 100%;
}
.tooltipBox tr td:first-child {
  font-weight: bold;
}
.tooltipBox tr td:last-child {
  text-align: right;
}
.dialog a, .dialog a:visited {
  color: grey;
  text-decoration: none;
}
.dialog a:hover, .dialog a:visited:hover {
  text-decoration: underline;
}
</style>
</head>
<body>
  <div id="parole">
  <v-app dark toolbar v-resize="onResize">
    <v-navigation-drawer permanent clipped absolute>
      <v-list dense
        v-for="list in menus"
        :key="list.id"
      >
        <v-subheader class="mt-3 grey--text text--darken-1">{{ list.name }}</v-subheader>
        <v-list-tile ripple
          v-for="item in list.options"
          v-if="(!item.only || item.only === menus[0].selected) && !(list.filters && item.id === menus[1].selected)"
          :key="item.id"
          :disabled="list.selected === item.id"
          :class="{'selected': !list.filters && item.selected, 'unselected': list.filters && item.selected === 'total'}"
          @click="selectOption(item.id, list.id, list.filters)"
        >
          <v-list-tile-action>
            <v-icon>{{ item.icon }}</v-icon>
          </v-list-tile-action>
          <v-list-tile-content>
            <v-list-tile-title v-if="!item.filters">
              {{ item.name }}
            </v-list-tile-title>
            <v-select v-else auto
              v-model="item.selected"
              :label="item.name"
              :items="item.filters"
              item-text="name"
              item-value="id"
              class="input-group--focused"
              @change="selectOption(item.id, list.id, $event)"
            ></v-select>
          </v-list-tile-content>
          <v-list-tile-action v-if="list.multi">
            <v-switch v-model="item.selected" light disabled></v-switch>
          </v-list-tile-action>
        </v-list-tile>
      </v-list>
    </v-navigation-drawer>
    <v-toolbar class="red" fixed>
      <v-toolbar-title>
        <a href="https://www.RegardsCitoyens.org" target="_blank" class="avatar mr-3">
          <img src="img/RC-avatar.png" title="Regards Citoyens" alt="RC">
        </a>
        Parole
      </v-toolbar-title>
      <v-spacer></v-spacer>
      <v-btn fab small outline class="red ml-3" @click.native.stop="help=true">
        <v-icon medium class="red">help</v-icon>
      </v-btn>
    </v-toolbar>
    <main>
      <svg></svg>
      <center><div class="legende">
        <button v-for="option in legende" class="btn btn--disabled btn--raised" :style="{'background-color': option.color+'!important'}">
          <div class="btn__content">{{ option.name }}</div>
        </button>
      </div></center>
    </main>
    <div class="tooltipBox">
      <center><b>{{ hoverDate }}</b></center>
      <hr/>
      <table>
        <tr v-for="option in legende">
          <td>{{ option.name }} :</td>
          <td>{{ option.value }} {{ unit }}</td>
        </tr>
      </table>
    </div>
    <v-dialog v-model="help" width="33%">
      <v-card>
        <v-card-title class="headline">Parole <small>&nbsp;&nbsp;par&nbsp;<a href="https://www.regardscitoyens.org" target="_blank">Regards Citoyens</a></small></v-card-title>
        <v-card-text>Réalisé à partir des <a href="https://github.com/regardscitoyens/nosdeputes.fr/blob/master/doc/opendata.md" target="_blank">données</a> de <a href="https://www.nosdeputes.fr" target="_blank">NosDéputés.fr</a> à l'aide de <a href="https://vuejs.org" target="_blank">VueJS</a> et <a href="https://vuetifyjs.com/" target="_blank">VuetifyJS</a>.</v-card-text>
        <v-card-text>Cette application est un logiciel libre sous licence AGPL dont le code source est <a href="https://github.com/rouxrc/parole" target="_blank">disponible sur GitHub</a>.</v-card-text>
        <v-card-actions>
          <v-spacer></v-spacer>
          <v-btn class="red--text darken-1" flat @click.native="help = false">Fermer</v-btn>
        </v-card-actions>
      </v-card>
    </v-dialog>
  </v-app>
  </div>

 <script src="js/d3.v4.min.js"></script>
 <script src="js/vue.min.js"></script>
 <script src="js/vuetify.min.js"></script>
 <script>
d3.formatDefaultLocale({
  "decimal": ",",
  "thousands": " ",
  "grouping": [3],
  "currency": ["€", ""],
});
d3.timeFormatDefaultLocale({
  "dateTime": "%A, le %e %B %Y, %X",
  "date": "%d/%m/%Y",
  "time": "%H:%M:%S",
  "periods": ["AM", "PM"],
  "days": ["dimanche", "lundi", "mardi", "mercredi", "jeudi", "vendredi", "samedi"],
  "shortDays": ["dim.", "lun.", "mar.", "mer.", "jeu.", "ven.", "sam."],
  "months": ["janvier", "février", "mars", "avril", "mai", "juin", "juillet", "août", "septembre", "octobre", "novembre", "décembre"],
  "shortMonths": ["Janv.", "Févr.", "Mars", "Avr.", "Mai", "Juin", "Juil.", "Août", "Sept.", "Oct.", "Nov.", "Déc."]
});

new Vue({
  el: "#parole",
  data: {
    menus: [{
      id: "activite",
      name: "Type d'activité",
      selected: "parole",
      options: [{
        id: "parole",
        name: "Temps de parole",
        icon: "mic"
      }]
    }, {
      id: "facet",
      name: "Répartition entre",
      selected: "groupes",
      options: [{
        id: "groupes",
        name: "Groupes politiques",
        icon: "people",
        legende: [{
          name: "LFI",
          color: "#e53935"
        }, {
          name: "GDR",
          color: "#ff5252"
        }, {
          name: "NG",
          color: "#F06292"
        }, {
          name: "LREM",
          color: "#FFA726"
        }, {
          name: "MODEM",
          color: "#FF7043"
        }, {
          name: "LC",
          color: "#42A5F5"
        }, {
          name: "LR",
          color: "#5C6BC0"
        }, {
          name: "NI",
          color: "#BDBDBD"
        }]
      }, {
        id: "genre",
        name: "Genres",
        icon: "wc",
        legende: [{
          name: "Femmes",
          color: "#F48FB1"
        }, {
          name: "Hommes",
          color: "#90CAF9"
        }]
      }, {
        id: "renouveau",
        name: "Anciens et nouveaux élus",
        icon: "repeat",
        legende: [{
          name: "Députés réélus",
          color: "#B39DDB"
        }, {
          name: "Nouveaux députés",
          color: "#B2DFDB"
        }]
      }, {
        id: "debats",
        name: "Commissions & Hémicycle",
        icon: "looks",
        only: "parole",
        legende: [{
          name: "Commissions",
          color: "#B39DDB"
        }, {
          name: "Hémicycle",
          color: "#B2DFDB"
        }]
      }, {
        id: "interventions",
        name: "Invectives & Interventions",
        icon: "speaker_notes",
        only: "parole",
        legende: [{
          name: "Invectives",
          color: "#B39DDB"
        }, {
          name: "Interventions longues",
          color: "#B2DFDB"
        }]
      }]
    }, {
      id: "filters",
      name: "Filtrer",
      filters: true,
      options: [{
        id: "groupes",
        name: "Groupe politique",
        icon: "person",
        selected: "total",
        filters: [{
          id: "total",
          name: "Tous les députés"
        }, {
          id: "LFI",
          name: "LFI"
        }, {
          id: "GDR",
          name: "GDR"
        }, {
          id: "NG",
          name: "NG"
        }, {
          id: "LREM",
          name: "LREM"
        }, {
          id: "MODEM",
          name: "MODEM"
        }, {
          id: "LC",
          name: "LC"
        }, {
          id: "LR",
          name: "LR"
        }, {
          id: "NI",
          name: "NI"
        }]
      }, {
        id: "genre",
        name: "Genre",
        icon: "person",
        selected: "total",
        filters: [{
          id: "total",
          name: "Tous les députés"
        }, {
          id: "F",
          name: "Femmes"
        }, {
          id: "H",
          name: "Hommes"
        }]
      }, {
        id: "renouveau",
        name: "Ancienneté",
        icon: "person_outline",
        selected: "total",
        filters: [{
          id: "total",
          name: "Tous les députés"
        }, {
          id: "anciens",
          name: "Députés réélus"
        }, {
          id: "nouveaux",
          name: "Nouveaux députés"
        }]
      }, {
        id: "debats",
        name: "Débats",
        icon: "mic",
        only: "parole",
        selected: "total",
        filters: [{
          id: "total",
          name: "Tous les débats"
        }, {
          id: "commissions",
          name: "en Commissions"
        }, {
          id: "hemicycle",
          name: "en Hémicycle"
        }]
      }, {
        id: "interventions",
        name: "Interventions",
        icon: "mic",
        only: "parole",
        selected: "total",
        filters: [{
          id: "total",
          name: "Toutes les interventions"
        }, {
          id: "invectives",
          name: "Invectives (- de 20 mots)"
        }, {
          id: "longues",
          name: "Interventions longues"
        }]
      }]
    }, {
      id: "vue",
      name: "Affichage",
      multi: true,
      options: [{
        id: "cumul",
        name: "Cumulatif",
        icon: "timeline",
        selected: false
      }, {
        id: "prop",
        name: "Proportionnel",
        icon: "dashboard",
        selected: false
      }]
    }],
    help: false,
    data: [],
    view: null,
    prop: false,
    unit: "mots",
    hoverDate: "",
    legende: [],
    resizing: null
  },
  mounted: function() {
    window.addEventListener("hashchange", this.updateView);
    var last;
    d3.csv("data/parole-deputes.csv", function(d, idx, columns) {
      var key;
      d.date = new Date(d.date);
      for (var i=1, n=columns.length; i<n; i++) {
        key = columns[i].replace(/_[^_]*$/, "");
        d[columns[i]] = +d[columns[i]];
        d[columns[i]+"_cumul"] = d[columns[i]] + (last ? last[columns[i]+"_cumul"] : 0);
        d[key] = (d[key] || 0) + d[columns[i]];
        d[key+"_cumul"] = (d[key+"_cumul"] || 0) + d[columns[i]+"_cumul"];
      }
      for (var i=1, n=columns.length; i<n; i++) {
        key = columns[i].replace(/_[^_]*$/, "");
        d[columns[i]+"_prop"] = (d[key] ? d[columns[i]] / d[key] : 0);
        d[columns[i]+"_cumul_prop"] = (d[key+"_cumul"] ? d[columns[i]+"_cumul"] / d[key+"_cumul"] : 0);
      }
      last = d;
      return d;
    }, this.initData);
  },
  methods: {
    onResize: function() {
      clearTimeout(this.resizing);
      this.resizing = setTimeout(this.drawChart, 50);
    },
    selectOption: function(optionId, menuId, filterId) {
      if (filterId === true) return;
      var update = false;
      this.menus.forEach(function(m) { if (m.id === menuId) {
        if (m.multi || m.filters) {
          m.options.forEach(function(o) { if (o.id === optionId) {
            o.selected = filterId || !o.selected;
            update = true;
          } });
        } else if (m.selected !== optionId) {
          m.selected = optionId;
          update = true;
        }
      } });
      if (update) this.setUrl();
    },
    setUrl: function() {
      window.location.hash = this.menus.map(function(m) {
        return m.id + "=" + ( m.multi ?
          m.options.filter(function(o) { return o.selected; })
            .map(function(o) { return o.id; })
            .join(",") :
          (m.filters ?
            m.options.filter(function(o) {
              return o.selected !== "total";
            }).map(function(o) {
              return o.id + ":" + o.selected;
            }).join(",") :
            m.selected
          )
        );
      }).filter(function(d) { return /=./.test(d); })
      .join("&");
    },
    readUrl: function() {
      var urlArgs = window.location.hash.slice(1).split(/&/),
        el, el2;
      this.menus[2].options.forEach(function(o) {
        o.selected = "total";
      });
      for (var i=0, n=urlArgs.length; i<n; i++) {
        el = urlArgs[i].split(/=/);
        this.menus
          .filter(function(m) { return m.id === el[0]; })
          .forEach(function(m) {
            if (m.multi)
              m.options.forEach(function(o) { o.selected = !!~el[1].indexOf(o.id); });
            else if (m.filters)
              el[1].split(/,/).forEach(function(e) {
                el2 = e.split(/:/);
                m.options
                 .filter(function(o) { return o.id === el2[0]; })
                 .forEach(function(o) { o.selected = el2[1]; });
              });
            else m.selected = el[1];
          });
      }
    },
    initData: function(data, error) {
      if (error) throw error;
      this.data = data;
      this.readUrl();
      this.setUrl();
    },
    updateView: function() {
      this.readUrl();
      this.drawChart();
    },
    drawChart: function() {
      var source = this.menus[2].options[3].selected,
        facet = this.menus[1].selected,
        facets = this.menus[1].options,
        views = [""]
          .concat(this.menus[3].options
            .filter(function(o) { return o.selected; })
            .map(function(o) { return o.id; })
          ).join("_"),
        cols = [source, facet].join("_"),
        colors = {};
      for (var i=0, n=facets.length; i<n; i++)
        if (facet === facets[i].id)
          this.legende = facets[i].legende;
      for (var i=0, n=this.legende.length; i<n; i++)
        colors[this.legende[i].name] = this.legende[i].color;

      var keys = this.legende.map(function(k) {
        return cols + "_" + k.name + views;
      });
      if (facet === "groupes") keys.reverse();
      this.view = cols + "_#" + views;
      this.prop = /prop/.test(views);

      var margin = {top: 50, right: 80, bottom: 140, left: 80},
        svgW = window.innerWidth - document.querySelector("aside").getBoundingClientRect().width,
        width = svgW - margin.left - margin.right,
        svgH = window.innerHeight - document.querySelector("nav").getBoundingClientRect().height,
        height = svgH - margin.top - margin.bottom,
        svg = d3.select("svg").attr("width", svgW).attr("height", svgH),
        xScale = d3.scaleTime().range([0, width])
          .domain(d3.extent(this.data, function(d) { return d.date; }))
          .nice(),
        yScale = d3.scaleLinear().range([height, 0]);

      if (!this.prop)
        yScale.domain([0, d3.max(this.data, function(d) { return d[cols + views]; })]);

      d3.select("svg g").remove();
      var g = svg.append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")"),
        stack = d3.stack().keys(keys),
        oneday = width / (xScale.domain()[1] - xScale.domain()[0]) * 86400000;

      g.append("g")
        .selectAll("g")
        .data(stack(this.data))
        .enter().append("g")
          .attr("fill", function(d) {
            return colors[d.key.replace(cols+"_", "").replace(/_(cumul|prop)/g, "")];
          })
        .selectAll("rect")
        .data(function(d) { return d; })
        .enter().append("rect")
          .attr("x", function(d) { return xScale(d.data.date); })
          .attr("y", function(d) { return yScale(d[1]); })
          .attr("width", oneday - 0.5)
          .attr("height", function(d) { return Math.max(0, yScale(d[0]) - yScale(d[1]) - 0.5); });

      g.append("g")
        .attr("class", "axis axis--x")
        .attr("transform", "translate(0," + (height) + ")")
        .call(d3.axisBottom(xScale).ticks(Math.floor(width / 175), d3.timeFormat("%d %b %y")));

      g.append("g")
        .selectAll("rect.tooltip")
        .data(this.data)
        .enter().append("rect")
          .classed("tooltip", true)
          .attr("x", function(d) { return xScale(d.date); })
          .attr("y", yScale.range()[1])
          .attr("width", oneday)
          .attr("height", yScale.range()[0] - yScale.range()[1])
          .on("mouseover", function(x, idx, rects) {
            d3.select(rects[idx]).style("fill-opacity", 0.15);
          })
          .on("mousemove", this.displayTooltip)
          .on("mouseleave", function(x, idx, rects) {
            d3.select(rects[idx]).style("fill-opacity", 0);
            d3.select(".tooltipBox")
             .style("display", "none");
          })

      this.resizing = null;
    },
    displayTooltip: function(x, idx, rects) {
      this.hoverDate = d3.timeFormat("%d %B %Y")(new Date(x.date));
      var tot = 0;
      for (var i=0, n=this.legende.length; i<n; i++) {
        this.legende[i].value = d3.format((this.prop ? ".2%" : ","))
          (x[this.view.replace("#", this.legende[i].name)]);
        tot += x[this.view.replace("#", this.legende[i].name)];
      }
      d3.select(".tooltipBox")
       .style("left", d3.event.pageX - 100 + "px")
       .style("top", d3.event.pageY + 30 + "px")
       .style("display", (tot ? "block" : "none"));
    }
  }
});
/* TODO
- add data (interventions courtes, amdmts déposés/adoptés, PPL, rapports, QE)
- other legislatures
- splitted view
- add transition d3 when switching view ?
- add comparator with actual proportions when prop view
- data updates
*/
 </script>
</body>
</html>
