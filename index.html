<!DOCTYPE html>
<html>
<head>
 <meta charset="UTF-8">
 <title>Parole - Regards Citoyens</title>
 <link href="css/roboto.css" rel="stylesheet">
 <link href="css/vuetify.min.css" rel="stylesheet">
<style>
html {
  overflow: hidden;
}
aside {
  height: 100%;
}
.navigation-drawer--permanent.navigation-drawer--clipped {
  max-height: calc(100vh);
}
.btn--floating.btn--small .icon {
  font-size: 30px;
}
.subheader {
  text-transform: uppercase;
}
.input-group__input .input-group__prepend-icon {
  color: white!important;
}
.input-group__input .input-group__append-icon {
  color: #f44336!important;
}
.input-group__details, .invisible {
  display: none!important;
}
.menu__content {
  max-height: 500px!important;
}
.chip {
  cursor: pointer;
}
.input-group--select .input-group__selections__comma {
  font-size: 14px;
}
.list__tile--active, .input-group.input-group--focused .input-group__append-icon, .application--dark .input-group.input-group--dirty .input-group__selections__comma:not(.input-group__selections__comma--active) {
  color: #f44336;
}
.unselected .list__tile--active, .unselected .input-group.input-group--focused .input-group__append-icon, .application--dark .unselected .input-group.input-group--dirty .input-group__selections__comma:not(.input-group__selections__comma--active) {
  color: white!important;
  opacity: 0.2!important;
}
.input-group.input-group--text-field:not(.input-group--single-line):not(.input-group--error).input-group--focused label {
  color: white;
}
.switch {
  left: 25%;
}
.select, .radio-group--row {
  padding: 0;
}
.application--dark .input-group.radio:not(.input-group--error) label {
  font-size: 13px;
  text-transform: capitalize;
  margin-left: -5px
}
.lowercase {
  text-transform: none!important;
}
.axis path, .axis line {
  stroke: grey;
}
.axis text {
  fill: grey;
  font-size: 14px;
  font-family: Roboto;
}
.legende button {
  color: black!important;
  font-weight: bold;
  height: 50px;
  min-width: 125px;
  padding: 2px;
}
.legende button div {
  display: grid;
}
rect.tooltip {
  fill: black;
  fill-opacity: 0;
}
.tooltipBox {
  background: lightgrey;
  border: 1px solid black;
  border-radius: 5px;
  color: black;
  display: none;
  min-width: 120px;
  position: absolute;
  top: 50%;
  left: 50%;
  padding: 5px;
  font-size: 14px;
  z-index: 1000;
}
.dialog a, .dialog a:visited {
  color: grey;
  text-decoration: none;
}
.dialog a:hover, .dialog a:visited:hover {
  text-decoration: underline;
}
</style>
</head>
<body>
  <div id="parole">
  <v-app dark toolbar>
    <aside class="navigation-drawer navigation-drawer--absolute navigation-drawer--clipped navigation-drawer--is-booted navigation-drawer--is-mobile navigation-drawer--open navigation-drawer--permanent">
      <v-list dense>
        <v-subheader class="mt-3 grey--text text--darken-1">Législature</v-subheader>
        <v-list-tile ripple>
          <v-list-tile-content><v-select auto single-line hide-details
            v-model="legislature"
            :items="legislatures"
            item-text="name"
            item-value="id"
            item-disabled="disabled"
            prepend-icon="account_balance"
            class="select"
            @change="legislature = $event"
          ></v-select></v-list-tile-content>
        </v-list-tile>

        <v-subheader class="mt-3 grey--text text--darken-1">Type d'activité</v-subheader>
        <v-list-tile ripple>
          <v-list-tile-content><v-select auto single-line hide-details
            v-model="activite"
            :items="activites"
            item-text="name"
            item-value="id"
            item-disabled="disabled"
            :prepend-icon="activiteIcon"
            class="select"
            @change="activite = $event"
          >
            <template slot="item" scope="f">
              <v-list-tile-action><v-icon v-html="f.item.icon"></v-icon></v-list-tile-action>
              <v-list-tile-content><v-list-tile-title v-html="f.item.name"></v-list-tile-title></v-list-tile-content>
            </template>
          </v-select></v-list-tile-content>
        </v-list-tile>

        <v-subheader class="mt-3 grey--text text--darken-1">Répartition entre</v-subheader>
        <v-list-tile ripple>
          <v-list-tile-content><v-select auto single-line hide-details
            v-model="facet"
            :items="availableFacets"
            item-text="name"
            item-value="id"
            :prepend-icon="facetIcon"
            class="select"
            @change="facet = $event"
          >
            <template slot="item" scope="f">
              <v-list-tile-action><v-icon v-html="f.item.icon"></v-icon></v-list-tile-action>
              <v-list-tile-content><v-list-tile-title v-html="f.item.name"></v-list-tile-title></v-list-tile-content>
            </template>
          </v-select></v-list-tile-content>
        </v-list-tile>

        <v-subheader class="mt-3 grey--text text--darken-1">Filtrage
          <v-spacer></v-spacer>
          <v-chip small outline close class="red--text"
            v-model="filtered"
            @input="clearFilters()"
            @click="clearFilters()"
          ><small>annuler</small></v-chip>
        </v-subheader>
        <v-list-tile
          v-for="item in facets"
          v-if="(!item.only || item.only === activite) && item.id !== facet"
          :class="{'unselected': item.selected === 'total'}"
        >
          <v-list-tile-action><v-icon>{{ item.icon }}</v-icon></v-list-tile-action>
          <v-list-tile-content><v-select auto
            v-model="item.selected"
            :label="item.filterName"
            :items="[{id: 'total', 'name': item.filterAll}].concat(item.legende)"
            item-text="name"
            item-value="id"
            class="input-group--focused"
            @change="selectFilter(item.id, $event)"
          ></v-select></v-list-tile-content>
        </v-list-tile>

        <v-subheader class="mt-3 grey--text text--darken-1">Affichage</v-subheader>
        <v-list-tile>
          <v-list-tile-action><v-icon>timeline</v-icon></v-list-tile-action>
          <v-list-tile-content><v-list-tile-title>Cumulatif</v-list-tile-title></v-list-tile-content>
          <v-list-tile-action><v-switch light v-model="cumul" color="red"></v-switch></v-list-tile-action>
        </v-list-tile>
        <v-list-tile>
          <v-list-tile-action><v-icon>dashboard</v-icon></v-list-tile-action>
          <v-list-tile-content><v-list-tile-title>Proportionnel</v-list-tile-title></v-list-tile-content>
          <v-list-tile-action><v-switch light v-model="prop" color="red"></v-switch></v-list-tile-action>
        </v-list-tile>
        <v-list-tile>
          <v-list-tile-action><v-icon>date_range</v-icon></v-list-tile-action>
          <v-radio-group row hide-details v-model="temps">
            <v-radio small color="red" v-for="c in ['jours', 'sems', 'mois']" :label="c" :value="c" :class="{'invisible': c === 'jours' && activite === 'questions'}"></v-radio>
          </v-radio-group>
        </v-list-tile>
      </v-list>
      <div class="navigation-drawer__border"></div>
    </aside>
    <v-toolbar class="red" fixed>
      <v-toolbar-title>
        <a href="https://www.RegardsCitoyens.org" target="_blank" class="avatar mr-3">
          <img src="img/RC-avatar.png" title="Regards Citoyens" alt="RC">
        </a>
        Parole
      </v-toolbar-title>
      <v-spacer></v-spacer>
      <v-btn fab small outline class="red ml-3" @click.native.stop="help = true">
        <v-icon medium class="red">help</v-icon>
      </v-btn>
    </v-toolbar>
    <main>
      <svg width=0 height=6000></svg>
      <center><div class="legende">
        <button v-for="option in legende" class="btn btn--disabled btn--raised" :style="{'background-color': option.color+'!important'}">
          <div class="btn__content">
            <span>{{ option.facetName || option.name || option.id }}</span>
            <span v-if="showValues && option.value" class="lowercase"><small>{{ option.value }}&nbsp;{{ unit }}</small></span>
          </div>
        </button>
      </div></center>
    </main>
    <div class="tooltipBox"><center><b>{{ hoverDate }}</b></center></div>
    <v-dialog v-model="help" width="33%">
      <v-card>
        <v-card-title class="headline">Parole <small>&nbsp;&nbsp;par&nbsp;<a href="https://www.regardscitoyens.org" target="_blank">Regards Citoyens</a></small></v-card-title>
        <v-card-text>Réalisé à partir des <a href="https://github.com/regardscitoyens/nosdeputes.fr/blob/master/doc/opendata.md" target="_blank">données</a> de <a href="https://www.nosdeputes.fr" target="_blank">NosDéputés.fr</a> à l'aide de <a href="https://vuejs.org" target="_blank">VueJS</a> et <a href="https://vuetifyjs.com/" target="_blank">VuetifyJS</a>.</v-card-text>
        <v-card-text>Cette application est un logiciel libre sous licence AGPL dont le code source est <a href="https://github.com/rouxrc/parole" target="_blank">disponible sur GitHub</a>.</v-card-text>
        <v-card-actions>
          <v-spacer></v-spacer>
          <v-btn class="red--text darken-1" flat @click.native="help = false">Fermer</v-btn>
        </v-card-actions>
      </v-card>
    </v-dialog>
  </v-app>
  </div>

 <script src="js/d3.v4.min.js"></script>
 <script src="js/vue.min.js"></script>
 <script src="js/vuetify.min.js"></script>
 <script>
d3.formatDefaultLocale({
  "decimal": ",",
  "thousands": " ",
  "grouping": [3],
  "currency": ["€", ""],
});
d3.timeFormatDefaultLocale({
  "dateTime": "%A, le %e %B %Y, %X",
  "date": "%d/%m/%Y",
  "time": "%H:%M:%S",
  "periods": ["AM", "PM"],
  "days": ["dimanche", "lundi", "mardi", "mercredi", "jeudi", "vendredi", "samedi"],
  "shortDays": ["dim.", "lun.", "mar.", "mer.", "jeu.", "ven.", "sam."],
  "months": ["janvier", "février", "mars", "avril", "mai", "juin", "juillet", "août", "septembre", "octobre", "novembre", "décembre"],
  "shortMonths": ["Janv.", "Févr.", "Mars", "Avr.", "Mai", "Juin", "Juil.", "Août", "Sept.", "Oct.", "Nov.", "Déc."]
});

d3.iso_jours = function(d) { return d3.timeFormat("%Y-%m-%d")(d); };
d3.iso_sems = function(d) {
  var dt = new Date(d - 86400000 * (d.getDay()-1));
  return d3.iso_jours(dt);
};
d3.iso_mois = function(d) {
  var dt = new Date(d);
  dt.setDate(1);
  return d3.iso_jours(dt);
};
d3.nextDate = function(d, dur) {
  var dt = new Date(d);
  if (dur === "mois") {
    dt.setMonth(dt.getMonth() + 1);
    dt.setDate(1);
  } else if (dur === "sems") {
    dt = new Date(d - 86400000 * (d.getDay()-1));
    dt.setDate(dt.getDate() + 7);
  } else dt.setDate(dt.getDate() + 1);
  return dt;
}

new Vue({
  el: "#parole",
  data: {
    legislature: "15",
    legislatures: [{
      id: "13",
      disabled: true,
      name: "13ème (2007 - 2012)"
    }, {
      id: "14",
      disabled: true,
      name: "14ème (2012 - 2017)"
    }, {
      id: "15",
      name: "15ème (2017 - ...)"
    }],
    activite: "parole",
    activites: [{
      id: "parole",
      name: "Temps de parole",
      icon: "mic",
      unit: "mots"
    }, {
      id: "amendements",
      name: "Amendements",
      icon: "spellcheck",
      unit: "amdts"
    }, {
      id: "propositions",
      disabled: true,
      name: "Propositions de lois",
      icon: "playlist_add",
      unit: "props"
    }, {
      id: "questions",
      name: "Questions écrites",
      icon: "help_outline",
      unit: "quests"
    }],
    facet: "groupes",
    facets: [{
      id: "groupes",
      name: "Groupes politiques",
      filterName: "Groupe politique",
      filterAll: "Tous les députés",
      icon: "people",
      selected: "total",
      legende: [
        {color: "#e53935", id: "LFI", name: "LFI"},
        {color: "#ff5252", id: "GDR", name: "GDR"},
        {color: "#F06292", id: "NG", name: "NG"},
        {color: "#FFA726", id: "LREM", name: "LREM"},
        {color: "#FF7043", id: "MODEM", name: "MODEM"},
        {color: "#42A5F5", id: "LC", name: "LC"},
        {color: "#5C6BC0", id: "LR", name: "LR"},
        {color: "#BDBDBD", id: "NI", name: "NI"}
      ]
    }, {
      id: "genre",
      name: "Genres",
      filterName: "Genre",
      filterAll: "Tous les députés",
      icon: "wc",
      selected: false,
      legende: [
        {color: "#F48FB1", id: "F", name: "Femmes"},
        {color: "#90CAF9", id: "H", name: "Hommes"}
      ]
    }, {
      id: "renouveau",
      name: "Anciens et nouveaux élus",
      filterName: "Ancienneté",
      filterAll: "Tous les députés",
      icon: "repeat",
      selected: "total",
      legende: [
        {color: "#B39DDB", id: "anciens", name: "Députés réélus"},
        {color: "#B2DFDB", id: "nouveaux", name: "Nouveaux députés"}
      ]
    }, {
      id: "debats",
      name: "Commissions & Hémicycle",
      filterName: "Débats",
      filterAll: "Tous les débats",
      icon: "looks",
      selected: "total",
      only: "parole",
      legende: [
        {color: "#B39DDB", id: "commissions", name: "en Commissions", facetName: "Commissions"},
        {color: "#B2DFDB", id: "hemicycle", name: "en Hémicycle", facetName: "Hémicycle"}
      ]
    }, {
      id: "interventions",
      name: "Invectives & Interventions",
      filterName: "Interventions",
      filterAll: "Toutes les interventions",
      icon: "speaker_notes",
      selected: "total",
      only: "parole",
      legende: [
        {color: "#B39DDB", id: "invectives", name: "Invectives ( - de 20 mots )", facetName: "Invectives"},
        {color: "#B2DFDB", id: "longues", name: "Interventions longues"}
      ]
    }, {
      id: "sorts",
      name: "Sort des amendements",
      filterName: "Amendements",
      filterAll: "Tous les amendements",
      icon: "spellcheck",
      selected: "total",
      only: "amendements",
      legende: [
        {color: "#69F0AE", id: "Adopté", name: "Adoptés"},
        {color: "#80D8FF", id: "Retiré", name: "Retirés"},
        {color: "#B2DFDB", id: "Tombe", name: "Tombés"},
        {color: "#FFE57F", id: "Non soutenu", name: "Non soutenus"},
        {color: "#FFAB40", id: "Irrecevable", name: "Irrecevables"},
        {color: "#ef9a9a", id: "Rejeté", name: "Rejetés"},
        {color: "#9E9E9E", id: "Indéfini", name: "Indéfinis"}
      ]
    }, {
      id: "statut",
      name: "État de la question",
      filterName: "Questions",
      filterAll: "Toutes les questions",
      icon: "help",
      selected: "total",
      only: "questions",
      legende: [
        {color: "#B39DDB", id: "reponse", name: "Satisfaites"},
        {color: "#B3B7B5", id: "retrait", name: "Retirées"},
        {color: "#B2DFDB", id: "attente", name: "En attente"}
      ]
    }, {
      id: "duree",
      name: "Durée d'attente",
      filterName: "Durée d'attente",
      filterAll: "Toutes les questions",
      icon: "help",
      selected: "total",
      only: "questions",
      legende: [
        {color: "#69F0AE", id: "1", name: "moins d'un mois", facetName: "- d'un mois"},
        {color: "#80D8FF", id: "2", name: "moins de 2 mois", facetName: "- de 2 mois"},
        {color: "#B2DFDB", id: "3", name: "moins de 3 mois", facetName: "- de 3 mois"},
        {color: "#FFE57F", id: "3-6", name: "entre 3 et 6 mois", facetName: "3 à 6 mois"}
      ], extralegende: [
        {color: "#FFAB40", id: "6-12", name: "entre 6 mois et un an", facetName: "6 à 12 mois"},
        {color: "#ef9a9a", id: "12+", name: "plus d'un an", facetName: "+ d'un an"}
      ]
    }, {
      id: "ministre",
      name: "Ministère interrogé",
      filterName: "Ministère interrogé",
      filterAll: "Tous les ministères",
      icon: "flag",
      selected: "total",
      only: "questions",
      legende: [
        {color: "grey", id: "Premier ministre", name: "Premier ministre"},
        {color: "grey", id: "Ministère de l'intérieur", name: "Intérieur"},
        {color: "grey", id: "Ministère de la transition écologique et solidaire", name: "Transition écologique & solidaire"},
        {color: "grey", id: "Ministère de la justice", name: "Justice"},
        {color: "grey", id: "Ministère de l'Europe et des affaires étrangères", name: "Europe & Affaires étrangères"},
        {color: "grey", id: "Ministère des armées", name: "Armées"},
        {color: "grey", id: "Ministère de la cohésion des territoires", name: "Cohésion des territoires"},
        {color: "grey", id: "Ministère des solidarités et de la santé", name: "Solidarités & Santé"},
        {color: "grey", id: "Ministère de l'économie et des finances", name: "Économie & Finances"},
        {color: "grey", id: "Ministère de la culture", name: "Culture"},
        {color: "grey", id: "Ministère du travail", name: "Travail"},
        {color: "grey", id: "Ministère de l'éducation nationale", name: "Éducation nationale"},
        {color: "grey", id: "Ministère de l'agriculture et de l'alimentation", name: "Agriculture & Alimentation"},
        {color: "grey", id: "Ministère de l'action et des comptes publics", name: "Action & Comptes publics"},
        {color: "grey", id: "Ministère de l'enseignement supérieur, de la recherche et de l'innovation", name: "Enseignement supérieur"},
        {color: "grey", id: "Ministère des outre-mer", name: "Outre-mer"},
        {color: "grey", id: "Ministère des sports", name: "Sports"},
        {color: "grey", id: "Premier ministre, chargé de l'égalité entre les femmes et les hommes", name: "Égalité F / H"},
        {color: "grey", id: "Premier ministre, chargé des personnes handicapées", name: "Personnes Handicapées"},
        {color: "grey", id: "Premier ministre, chargé du numérique", name: "Numérique"},
        {color: "grey", id: "Ministère de la transition écologique et solidaire, chargé des transports", name: "Transports"},
        {color: "grey", id: "Ministère de l'Europe et des affaires étrangères, chargé des affaires européennes", name: "Affaires européennes"},
      ]
    }],
    resizing: null,
    data: {},
    cumul: false,
    prop: false,
    temps: "jours",
    hoverDate: "",
    showValues: false,
    help: false
  },
  computed: {
    dkey: function() { return this.activite + "_" + this.legislature; },
    unit: function() {
      var act = this.activite;
      return this.activites.filter(function(a) { return a.id === act; })[0].unit;
    },
    activiteIcon: function() {
      var act = this.activite;
      return this.activites.filter(function(a) { return a.id === act; })[0].icon;
    },
    availableFacets: function() {
      var act = this.activite;
      return this.facets.filter(function(f) { return !f.only || f.only === act; });
    },
    facetIcon: function() {
      var facet = this.facet;
      return this.facets.filter(function(f) { return f.id === facet; })[0].icon;
    },
    legende: function() {
      var facet = this.facet;
      return this.facets.filter(function(f) { return f.id === facet; })[0].legende;
    },
    filtered: function() {
      var facet = this.facet;
      return this.facets.some(function(f) { return f.selected !== "total" && f.id !== facet; });
    },
    activeFilters: function() {
      var act = this.activite, facet = this.facet;
      return this.facets.filter(function(f) {
        return f.selected !== "total" && (!f.only || f.only === act) && f.id !== facet;
      });
    },
    _cumul: function() { return this.cumul ? "_cumul" : ""; },
    _prop: function() { return this.prop ? "_prop" : ""; }
  },
  mounted: function() {
    this.readUrl();
    window.addEventListener("hashchange", this.readUrl);
    window.addEventListener("resize", this.onResize);
    this.$watch(
      function() { return [this.dkey, this.facet, this.cumul, this.prop, this.temps]; },
      this.updateUrl
    );
  },
  methods: {
    onResize: function() {
      if (this.resizing) return clearTimeout(this.resizing);
      this.resizing = setTimeout(this.drawChart, 50);
    },
    selectFilter: function(optionId, filterId) {
      this.facets.filter(function(f) { return f.id === optionId; })
      .forEach(function(f) { f.selected = filterId; });
      this.updateUrl();
    },
    clearFilters: function() {
      this.facets.forEach(function(f) { f.selected = "total"; });
      this.updateUrl();
    },
    updateUrl: function() {
      window.location.hash = "activite=" + this.activite +
        "&leg=" + this.legislature +
        "&facet=" + this.facet +
        (this.activeFilters.length ? "&filters=" : "") +
        this.activeFilters.map(function(f) { return f.id + ":" + f.selected; }).join("|") +
        (this.cumul ? "&cumul" : "") +
        (this.prop ? "&prop" : "") +
        "&temps=" + this.temps;
    },
    readUrl: function() {
      var el, el2, options = {};
      window.location.hash.slice(1).split(/&/).forEach(function(opt) {
        el = opt.split(/=/);
        if (el[0] === "filters") {
          options[el[0]] = {};
          el[1].split(/\|/).forEach(function(e) {
            el2 = e.split(/:/);
            options[el[0]][el2[0]] = el2[1];
          });
        } else options[el[0]] = el[1] || true;
      })
      this.legislature = options.leg || this.legislature;
      this.activite = options.activite || this.activite;
      this.facet = options.facet || this.facet;
      this.facets.forEach(function(f) { f.selected = (options.filters || {})[f.id] || "total"; });
      this.cumul = options.cumul;
      this.prop = options.prop;
      this.temps = options.temps || this.temps;
      if (!this.data[this.dkey]) {
        d3.select("svg g").remove();
        d3.tsv("data/" + this.dkey + ".tsv", function(d) {
          d.date = new Date(d.date);
          d.date.setHours(0);
          d.jours = d3.iso_jours(d.date);
          d.sems = d3.iso_sems(d.date);
          d.mois = d3.iso_mois(d.date);
          d.total = +d.total;
          return d;
        }, this.drawChart);
      } else this.$nextTick(this.drawChart);
    },
    drawChart: function(curData, error) {
      // Handle ajax result
      if (error) throw error;
      if (curData) this.data[this.dkey] = curData;
      else curData = this.data[this.dkey];
      if (!curData) return console.log("No data!");

      // Clear unavailable facet choice
      var facet = this.facet,
        only = this.facets.filter(function(f) { return f.id === facet; })[0].only;
      if (only && only !== this.activite) {
        this.facet = this.facets[0].id;
        return this.updateUrl();
      } else if (this.activite === "questions" && this.temps === "jours") {
        this.temps = "sems";
        return this.updateUrl();
      }

      // Prepare view settings
      var _cumul = this._cumul,
        _prop = this._prop,
        temps = this.temps,
        colors = {};
      this.legende.forEach(function(k) { colors[k.id] = k.color; });
      var keys = this.legende.map(function(k) { return k.id; });
      if (facet === "groupes") keys.reverse();

      // Agregate and filter data
      var hashdata = {},
        activeFilters = this.activeFilters;
      d3.nest()
      .key(function(d) { return d[temps]; })
      .key(function(d) { return d[facet]; })
      .rollup(function(lvs) { return d3.sum(lvs, function(d) {return d.total;}); })
      .entries(curData.filter(function(d) {
        return activeFilters.every(function(f) { return d[f.id] === f.selected; });
      })).forEach(function(k) {
        hashdata[k.key] = {};
        k.values.forEach(function(v) {
          hashdata[k.key][v.key] = v.value;
        });
      });

      // Build all dates data with cumul & prop
      var last = {},
        data = [],
        start = curData[0].date,
        end = new Date(curData[curData.length - 1].date);
      end.setDate(end.getDate() + 1);
      d3.timeDay.range(start, end)
      .filter(function(d, idx) {
        return !idx || temps === "jours" ||
          (temps === "sems" && d.getDay() == 1) ||
          (temps === "mois" && d.getDate() == 1);
      }).map(function(d) {
        return {
          date: d,
          temps: d3["iso_"+temps](d)
        };
      }).forEach(function(d) {
        var o = {
          date: d.date,
          legend: (temps === "sems" ? "semaine du " : "") +
            d3.timeFormat((temps !== "mois" ? "%e " : "") + "%B %Y")(d.date),
          sum: 0,
          sum_cumul: 0
        };
        keys.forEach(function(k) {
          o[k] = (hashdata[d.temps] || {})[k] || 0;
          o.sum += o[k];
          o[k+"_cumul"] = o[k] + (last[k+"_cumul"] || 0);
          o.sum_cumul += o[k+"_cumul"];
        });
        keys.forEach(function(k) {
          o[k+"_prop"] = (o.sum ? o[k] / o.sum : 0);
          o[k+"_cumul_prop"] = (o.sum_cumul ? o[k+"_cumul"] / o.sum_cumul : 0);
        });
        data.push(o);
        last = o;
      });
      
      // Setup dimensions
      var margin = {top: 40, right: 60, bottom: 40, left: 60},
        svgW = window.innerWidth - document.querySelector("aside").getBoundingClientRect().width,
        width = svgW - margin.left - margin.right,
        svgH = window.innerHeight - document.querySelector("nav").getBoundingClientRect().height - document.querySelector(".legende").getBoundingClientRect().height - 20,
        height = svgH - margin.top - margin.bottom,
        svg = d3.select("svg").attr("width", svgW).attr("height", svgH),
        xScale = d3.scaleTime().range([0, width]).domain([start, end]),
        xPosition = function(d) { return xScale(d3.max([start, d.date || d.data.date])); },
        xWidth = function(d) { return xScale(d3.min([end, d3.nextDate(d.date || d.data.date, temps)])) - xPosition(d); },
        yScale = d3.scaleLinear().range([height, 0]);
      if (!this.prop)
        yScale.domain([0, d3.max(data, function(d) { return d["sum"+_cumul]; })]);

      // Prepare svg
      d3.select("svg g").remove();
      var g = d3.select("svg")
      .attr("width", svgW)
      .attr("height", svgH)
      .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      // Draw histogram
      g.append("g")
        .selectAll("g")
        .data(d3.stack().keys(keys.map(function(k) { return k + _cumul + _prop; }))(data))
        .enter().append("g")
          .attr("fill", function(d) { return colors[d.key.replace(/_.*$/, "")] || "grey"; })
          .selectAll("rect")
          .data(function(d) { return d; })
          .enter().append("rect")
            .attr("x", xPosition)
            .attr("y", function(d) { return yScale(d[1]); })
            .attr("width", function(d) { return xWidth(d) - 0.5; })
            .attr("height", function(d) { return Math.max(0, yScale(d[0]) - yScale(d[1]) - 0.5); });

      // Draw axis
      g.append("g")
        .attr("class", "axis axis--x")
        .attr("transform", "translate(0," + (height) + ")")
        .call(d3.axisBottom(xScale).ticks(Math.floor(width / 175), d3.timeFormat("%d %b %y")));

      // Draw tooltips surfaces
      g.append("g")
        .selectAll("rect.tooltip")
        .data(data)
        .enter().append("rect")
          .classed("tooltip", true)
          .attr("x", xPosition)
          .attr("y", yScale.range()[1])
          .attr("width", xWidth)
          .attr("height", yScale.range()[0] - yScale.range()[1])
          .on("mouseover", function(d, idx, rects) { d3.select(rects[idx]).style("fill-opacity", 0.15); })
          .on("mousemove", this.displayTooltip)
          .on("mouseleave", this.clearTooltip);

      this.resizing = null;
    },
    displayTooltip: function(d) {
      this.hoverDate = d.legend;
      this.showValues = true;
      var tot = 0;
      for (var i=0, n=this.legende.length; i<n; i++) {
        var leg = this.legende[i],
          key = leg.id + this._cumul + this._prop;
        leg.value = d3.format(this.prop ? ".1%" : ",")(d[key]);
        tot += d[key];
      }
      d3.select(".tooltipBox")
      .style("left", d3.event.pageX - 60 + "px")
      .style("top", d3.event.pageY + 20 + "px")
      .style("display", (tot ? "block" : "none"));
    },
    clearTooltip: function(d, idx, rects) {
      this.showValues = false;
      d3.select(rects[idx]).style("fill-opacity", 0);
      d3.select(".tooltipBox").style("display", "none");
    }
  }
});
/* TODO
- adjust color/icons/displaylongnames
- add activities (PPL)
- add dynamic keys
- add splitted view
- add other legislatures data
- add comparator with actual proportions when prop view
- data updates
- add filter cumul ?
- add transition d3 when switching view ?
*/
 </script>
</body>
</html>
