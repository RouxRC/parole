<!DOCTYPE html>
<html>
<head>
 <meta charset="UTF-8">
 <title>Parole - Regards Citoyens</title>
 <link href="css/roboto.css" rel="stylesheet">
 <link href="css/vuetify.min.css" rel="stylesheet">
<style>
html {
  overflow: hidden;
}
#parole, #parole .container {
  height: 100%;
  overflow: hidden;
  z-index: 0;
}
.subheader {
  text-transform: uppercase;
}
.selected {
  background-color: grey;
}
.selected .list__tile {
  opacity: 1!important;
}
.axis path, .axis line {
  stroke: #AAA;
}
.axis text {
  fill: #AAA;
}
text {
  fill: #CCC;
  font-size: 14px;
  font-family: Roboto;
}
.legende {
  position: relative;
  bottom: 90px;
}
.legende button {
  color: black!important;
  font-weight: bold;
}
rect.tooltip {
  fill: black;
  fill-opacity: 0;
}
.tooltipBox {
  background: white;
  border: 1px solid black;
  display: none;
  width: 200px;
  position: absolute;
  top: 50%;
  left: 50%;
  padding: 7px;
  font-size: 14px;
  z-index: 1000;
}
</style>
</head>
<body>
  <div id="parole">
  <v-app dark toolbar v-resize="onResize">
    <v-navigation-drawer permanent clipped absolute>
      <v-list
        v-for="list in menus"
        :key="list.id"
      >
        <v-subheader class="mt-3 grey--text text--darken-1">{{ list.name }}</v-subheader>
        <v-list-tile
          v-for="item in list.options"
          :key="item.id"
          :disabled="list.selected === item.id"
          :class="{selected: list.selected === item.id}"
          ripple
          @click="selectOption(item.id, list.id, $event)"
        >
          <v-list-tile-action>
            <v-icon>{{ item.icon }}</v-icon>
          </v-list-tile-action>
          <v-list-tile-content>
            <v-list-tile-title>
              {{ item.name }}
            </v-list-tile-title>
          </v-list-tile-content>
        </v-list-tile>
      </v-list>
    </v-navigation-drawer>
    <v-toolbar class="red" fixed>
      <v-toolbar-title>
        Parole
      </v-toolbar-title>
    </v-toolbar>
    <main>
      <svg></svg>
      <center><div class="legende">
        <button v-for="option in legende" type="button" class="btn btn--disabled btn--raised btn--round" :style="{'background-color': option.color+'!important'}">
          <div class="btn__content">{{ option.name }}</div>
        </button>
      </div></center>
    </main>
    <div class="tooltipBox">
    </div>
  </v-app>
  </div>
 
 <script src="js/d3.v4.min.js"></script>
 <script src="js/vue.min.js"></script>
 <script src="js/vuetify.min.js"></script>
 <script>
d3.timeFormat = d3.timeFormatLocale({
  "dateTime": "%A, le %e %B %Y, %X",
  "date": "%d/%m/%Y",
  "time": "%H:%M:%S",
  "periods": ["AM", "PM"],
  "days": ["dimanche", "lundi", "mardi", "mercredi", "jeudi", "vendredi", "samedi"],
  "shortDays": ["dim.", "lun.", "mar.", "mer.", "jeu.", "ven.", "sam."],
  "months": ["janvier", "février", "mars", "avril", "mai", "juin", "juillet", "août", "septembre", "octobre", "novembre", "décembre"],
  "shortMonths": ["Janv.", "Févr.", "Mars", "Avr.", "Mai", "Juin", "Juil.", "Août", "Sept.", "Oct.", "Nov.", "Déc."]
}).format;

new Vue({
  el: "#parole",
  data: {
    menus: [{
      id: "facet",
      name: "Répartition entre",
      selected: "groupes",
      options: [{
        id: "groupes",
        name: "Groupes politiques",
        icon: "people",
        legende: [{
          name: "LFI",
          color: "#e53935"
        }, {
          name: "GDR",
          color: "#ff5252"
        }, {
          name: "NG",
          color: "#F06292"
        }, {
          name: "LREM",
          color: "#FFA726"
        }, {
          name: "MODEM",
          color: "#FF7043"
        }, {
          name: "LC",
          color: "#42A5F5"
        }, {
          name: "LR",
          color: "#5C6BC0"
        }, {
          name: "NI",
          color: "#BDBDBD"
        }]
      }, {
        id: "sexe",
        name: "Sexes",
        icon: "wc",
        legende: [{
          name: "Femmes",
          color: "#F48FB1"
        }, {
          name: "Hommes",
          color: "#90CAF9"
        }]
      }, {
        id: "oldnew",
        name: "Anciens et nouveaux élus",
        icon: "repeat",
        legende: [{
          name: "Députés réélus",
          color: "#B39DDB"
        }, {
          name: "Nouveaux députés",
          color: "#B2DFDB"
        }]
      }]
    }, {
      id: "view",
      name: "Affichage",
      selected: "prop",
      options: [{
        id: "day",
        name: "Quotidien",
        icon: "equalizer"
      }, {
        id: "grow",
        name: "Cumulatif",
        icon: "timeline"
      }, {
        id: "prop",
        name: "Proportionnel",
        icon: "dashboard"
      }]
    }, {
      id: "source",
      name: "Débats considérés",
      selected: "total",
      options: [{
        id: "total",
        name: "Commissions et Hémicycle",
        icon: "account_balance"
      }, {
        id: "commissions",
        name: "Commissions uniquement",
        icon: "mic"
      }, {
        id: "hemicycle",
        name: "Hémicycle uniquement",
        icon: "looks"
      }]
    }],
    data: [],
    legende: [],
    resizing: null
  },
  mounted: function() {
    window.addEventListener("hashchange", this.updateView);
    var totaux = {},
      last;
    d3.csv("data/parole-deputes.csv", function(d, idx, columns) {
      var key;
      d.date = new Date(d.date);
      for (var i=1, n=columns.length; i<n; i++) {
        d[columns[i]] = +d[columns[i]];
        d[columns[i]+"_grow"] = d[columns[i]] + (last ? last[columns[i]+"_grow"] : 0);
        key = columns[i].replace(/_[^_]*$/, "");
        if (!totaux[key]) totaux[key] = 0;
        totaux[key] += d[columns[i]];
        if (!d[key+"_sum"]) d[key+"_sum"] = 0;
        d[key+"_sum"] += d[columns[i]];
        if (!d[key+"_tot"]) d[key+"_tot"] = 0;
        d[key+"_tot"] += d[columns[i]+"_grow"];
      }
      for (var i=1, n=columns.length; i<n; i++) {
        key = columns[i].replace(/_[^_]*$/, "");
        if (totaux[key]) d[columns[i]+"_prop"] = d[columns[i]+"_grow"] / totaux[key];
        else d[columns[i]+"_prop"] = 0;
      }
      last = d;
      return d;
    }, this.initData);
  },
  methods: {
    onResize: function() {
      clearTimeout(this.resizing);
      this.resizing = setTimeout(this.drawChart, 50);
    },
    selectOption: function(optionId, menuId, e) {
      for (var i=0, n=this.menus.length; i<n; i++) {
        if (this.menus[i].id === menuId && this.menus[i].selected !== optionId) {
          this.menus[i].selected = optionId;
          this.setUrl();
          this.drawChart();
        }
      };
    },
    setUrl: function() {
      window.location.hash = this.menus.map(function(d) {
        return d.id + "=" + d.selected;
      }).join("&");
    },
    readUrl: function() {
      var urlArgs = window.location.hash.slice(1).split(/&/),
        el;
      for (var i=0, n=urlArgs.length; i<n; i++) {
        el = urlArgs[i].split(/=/);
        this.menus.filter(function(d) {
          return d.id === el[0];
        }).forEach(function(d) {
          d.selected = el[1];
        });
      }
    },
    initData: function(data, error) {
      if (error) throw error;
      this.data = data;
      this.updateView();
    },
    updateView: function() {
      this.readUrl();
      this.drawChart();
    },
    drawChart: function() {
      var facet = this.menus[0].selected,
        facets = this.menus[0].options,
        view = this.menus[1].selected,
        source = this.menus[2].selected,
        cols = source + "_" + facet + "_",
        colors = {};
      for (var i=0, n=facets.length; i<n; i++)
        if (facet === facets[i].id)
          this.legende = facets[i].legende;
      for (var i=0, n=this.legende.length; i<n; i++)
        colors[this.legende[i].name] = this.legende[i].color;
 
      var keys = this.legende.map(function(k) {
        return cols + k.name + (view !== "day" ? "_"+view : "");
      });
      if (facet === "groupes") keys.reverse();

      var margin = {top: 50, right: 80, bottom: 140, left: 80},
        svgW = window.innerWidth - document.querySelector("aside").getBoundingClientRect().width,
        width = svgW - margin.left - margin.right,
        svgH = window.innerHeight - document.querySelector("nav").getBoundingClientRect().height,
        height = svgH - margin.top - margin.bottom,
        svg = d3.select("svg").attr("width", svgW).attr("height", svgH),
        xScale = d3.scaleTime().range([0, width])
          .domain(d3.extent(this.data, function(d) { return d.date; }))
          .nice(),
        yScale = d3.scaleLinear().range([height, 0]),
        stack = d3.stack().keys(keys);
      if (view !== "prop")
        yScale.domain([0, d3.max(this.data, function(d) {
          return d[cols+(view === "day" ? "sum" : "tot")];
        })]).nice();

      d3.select("svg g").remove();
      var g = svg.append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      g.append("g")
        .selectAll("g")
        .data(stack(this.data))
        .enter().append("g")
          .attr("fill", function(d) {
            return colors[d.key.replace(cols, "").replace(/_(prop|grow)$/, "")];
          })
        .selectAll("rect")
        .data(function(d) { return d; })
        .enter().append("rect")
          .attr("x", function(d) { return xScale(d.data.date); })
          .attr("y", function(d) { return yScale(d[1]); })
          .attr("width", function(d) {
            var week = new Date(d.data.date);
            week.setDate(week.getDate() + 1);
            return Math.max(0, xScale(week) - xScale(d.data.date) - 0.5);
          })
          .attr("height", function(d) {
            return Math.max(0, yScale(d[0]) - yScale(d[1]) - 0.5);
          });
    
      g.append("g")
        .attr("class", "axis axis--x")
        .attr("transform", "translate(0," + (height) + ")")
        .call(d3.axisBottom(xScale).tickFormat(d3.timeFormat("%d %b")));
    
      g.append("g")
        .selectAll("rect.tooltip")
        .data(this.data)
        .enter().append("rect")
          .classed("tooltip", true)
          .attr("x", function (d) { return xScale(d.date); })
          .attr("y", function (d) { return yScale.range()[1]; })
          .attr("width", function(d) {
            var week = new Date(d.date);
            week.setDate(week.getDate() + 1);
            return Math.max(0, xScale(week) - xScale(d.date));
          })
          .attr("height", function (d) { 
            return yScale.range()[0] - yScale.range()[1];
          })
          .on("mouseover", function (x, idx, rects){
            d3.select(rects[idx]).style("fill-opacity", 0.15);
            console.log(x);
          })
          .on("mousemove", function(e) {
            var x = d3.event.pageX - 100
            d3.select(".tooltipBox")
             .style("left", d3.event.pageX - 100 + "px")
             .style("top", d3.event.pageY + 40 + "px")
          //   .style("display", "block");
          })
          .on("mouseleave", function(x, idx, rects) {
            d3.select(rects[idx]).style("fill-opacity", 0);
            d3.select(".tooltipBox")
             .style("display", "none");
          })

      this.resizing = null;
    }
  }
});
/* TODO
- adjust tooltips;
 + fill values
 + style with material
- add info credits
- add more data ?
- add more legislatures ?
*/
 </script>
</body>
</html>
