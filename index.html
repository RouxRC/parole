<!DOCTYPE html>
<html>
<head>
 <meta charset="UTF-8">
 <title>Parole - Regards Citoyens</title>
 <link href="css/roboto.css" rel="stylesheet">
 <link href="css/vuetify.min.css" rel="stylesheet">
<style>
html {
  overflow: hidden;
}
#parole, #parole .container {
  height: 100%;
  overflow: hidden;
  z-index: 0;
}
.subheader {
  text-transform: uppercase;
}
.selected {
  background-color: grey;
}
.selected .list__tile {
  opacity: 1!important;
}
.axis path, .axis line {
  stroke: #AAA;
}
.axis text {
  fill: #AAA;
}
text {
  fill: #CCC;
  font-size: 14px;
  font-family: Roboto;
}
.legende {
  width: 100%;
  position: absolute;
  bottom: 30px;
}
.legende button {
  color: black!important;
  font-weight: bold;
}
</style>
</head>
<body>
  <div id="parole">
  <v-app dark toolbar v-resize="onResize">
    <v-navigation-drawer permanent clipped absolute>
      <v-list
        v-for="list in menus"
        :key="list.name"
      >
        <v-subheader class="mt-3 grey--text text--darken-1">{{ list.name }}</v-subheader>
        <v-list-tile
          v-for="item in list.options"
          :key="item.id"
          :disabled="list.selected === item.id"
          :class="{selected: list.selected === item.id}"
          ripple
          @click="selectOption(item.id, list.name, $event)"
        >
          <v-list-tile-action>
            <v-icon>{{ item.icon }}</v-icon>
          </v-list-tile-action>
          <v-list-tile-content>
            <v-list-tile-title>
              {{ item.name }}
            </v-list-tile-title>
          </v-list-tile-content>
        </v-list-tile>
      </v-list>
    </v-navigation-drawer>
    <v-toolbar class="red" fixed>
      <v-toolbar-title>
        Parole
      </v-toolbar-title>
    </v-toolbar>
    <main>
      <v-container fill-height>
        <svg></svg>
        <div class="legende">
          <button v-for="option in legende" type="button" class="btn btn--disabled btn--raised btn--round" :style="{'background-color': option.color+'!important'}">
            <div class="btn__content">{{ option.name }}</div>
          </button>
        </div>
      </v-container>
    </main>
  </v-app>
  </div>
 
 <script src="js/d3.v4.min.js"></script>
 <script src="js/vue.min.js"></script>
 <script src="js/vuetify.min.js"></script>
 <script>

new Vue({
  el: "#parole",
  data: {
    menus: [{
      name: "Répartition entre",
      selected: "groupes",
      options: [{
        id: "groupes",
        name: "Groupes politiques",
        icon: "people",
        legende: [{
          name: "LFI",
          color: "#e53935"
        }, {
          name: "GDR",
          color: "#ff5252"
        }, {
          name: "NG",
          color: "#F06292"
        }, {
          name: "LREM",
          color: "#FFA726"
        }, {
          name: "MODEM",
          color: "#FF7043"
        }, {
          name: "LC",
          color: "#42A5F5"
        }, {
          name: "LR",
          color: "#5C6BC0"
        }, {
          name: "NI",
          color: "#BDBDBD"
        }]
      }, {
        id: "sexe",
        name: "Sexes",
        icon: "wc",
        legende: [{
          name: "Femmes",
          color: "#F48FB1"
        }, {
          name: "Hommes",
          color: "#90CAF9"
        }]
      }, {
        id: "oldnew",
        name: "Anciens et nouveaux élus",
        icon: "repeat",
        legende: [{
          name: "Députés réélus",
          color: "#B39DDB"
        }, {
          name: "Nouveaux députés",
          color: "#B2DFDB"
        }]
      }]
    }, {
      name: "Affichage",
      selected: "prop",
      options: [{
        id: "hebdo",
        name: "Hebdomadaire",
        icon: "equalizer"
      }, {
        id: "grow",
        name: "Cumulatif",
        icon: "timeline"
      }, {
        id: "prop",
        name: "Proportionnel",
        icon: "dashboard"
      }]
    }, {
      name: "Débats considérés",
      selected: "total",
      options: [{
        id: "total",
        name: "Commissions et Hémicycle",
        icon: "account_balance"
      }, {
        id: "commissions",
        name: "Commissions uniquement",
        icon: "mic"
      }, {
        id: "hemicycle",
        name: "Hémicycle uniquement",
        icon: "looks"
      }]
    }],
    data: [],
    legende: [],
    resizing: null
  },
  mounted: function() {
    var totaux = {},
      last;
    d3.csv("data/parole-deputes.csv", function(d, idx, columns) {
      var key;
      d.date = new Date(d.date);
      for (var i=1, n=columns.length; i<n; i++) {
        d[columns[i]] = +d[columns[i]];
        d[columns[i]+"_grow"] = d[columns[i]] + (last ? last[columns[i]+"_grow"] : 0);
        key = columns[i].replace(/_[^_]*$/, "");
        if (!totaux[key]) totaux[key] = 0;
        totaux[key] += d[columns[i]];
        if (!d[key+"_sum"]) d[key+"_sum"] = 0;
        d[key+"_sum"] += d[columns[i]];
        if (!d[key+"_tot"]) d[key+"_tot"] = 0;
        d[key+"_tot"] += d[columns[i]+"_grow"];
      }
      for (var i=1, n=columns.length; i<n; i++) {
        key = columns[i].replace(/_[^_]*$/, "");
        if (totaux[key]) d[columns[i]+"_prop"] = d[columns[i]+"_grow"] / totaux[key];
        else d[columns[i]+"_prop"] = 0;
      }
      last = d;
      return d;
    }, this.initData);
  },
  methods: {
    onResize: function() {
      clearTimeout(this.resizing);
      this.resizing = setTimeout(this.drawChart, 50);
    },
    selectOption: function(optionId, optionMenu, e) {
      for (var i=0, n=this.menus.length; i<n; i++) {
        if (this.menus[i].name === optionMenu && this.menus[i].selected !== optionId) {
          this.menus[i].selected = optionId;
          this.drawChart();
        }
      };
    },
    initData: function(data, error) {
      if (error) throw error;
      this.data = data;
      this.drawChart();
    },
    drawChart: function() {
      var facet = this.menus[0].selected,
        facets = this.menus[0].options,
        view = this.menus[1].selected,
        source = this.menus[2].selected,
        cols = source + "_" + facet + "_",
        colors = {};
      for (var i=0, n=facets.length; i<n; i++)
        if (facet === facets[i].id)
          this.legende = facets[i].legende;
      for (var i=0, n=this.legende.length; i<n; i++)
        colors[this.legende[i].name] = this.legende[i].color;
 
      var keys = this.legende.map(function(k) { return cols + k.name + (view !== "hebdo" ? "_"+view : "") });
      if (facet === "groupes") keys.reverse();

      var margin = {top: 50, right: 60, bottom: 140, left: 20},
        svgWidth = window.innerWidth - document.querySelector("aside").getBoundingClientRect().width,
        width = svgWidth - margin.left - margin.right,
        svgHeight = window.innerHeight - document.querySelector("nav").getBoundingClientRect().height,
        height = svgHeight - margin.top - margin.bottom,
        svg = d3.select("svg")
          .attr("width", svgWidth)
          .attr("height", svgHeight),
        xScale = d3.scaleTime().range([0, width])
          .domain(d3.extent(this.data, function(d) { return d.date; })),
        yScale = d3.scaleLinear().range([height, 0]),
        stack = d3.stack()
          .keys(keys),
        area = d3.area()
          .x(function(d) { return xScale(d.data.date); })
          .y0(function(d) { return yScale(d[0]); })
          .y1(function(d) { return yScale(d[1]); });
      if (view !== "prop")
        yScale.domain([0, d3.max(this.data, function(d) { return d[cols+(view === "hebdo" ? "sum" : "tot")]; })]).nice();

      d3.select("svg g").remove();
      var g = svg.append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")"),
      layer = g.selectAll(".layer")
        .data(stack(this.data))
        .enter().append("g")
          .attr("class", "layer");
    
      layer.append("path")
        .attr("class", "area")
        .style("fill", function(d) { return colors[d.key.replace(cols, "").replace(/_(prop|grow)$/, "")]; })
        .attr("d", area);
    
      g.append("g")
        .attr("class", "axis axis--x")
        .attr("transform", "translate(0," + (height) + ")")
        .call(d3.axisBottom(xScale).tickFormat(d3.timeFormat("%d %b")));
    
      this.resizing = null;
    }
  }
});
/* TODO
- bring back locale
- adjust legend positioning
- add tooltips
- add url rooting
*/
 </script>
</body>
</html>
